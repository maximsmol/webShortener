#!/usr/bin/env node

'use strict';

var util = require('util');
var path = require('path');
var fs = require('fs');

var minimist = require('minimist');
var Shortener = require('../lib/webShortener.js');


var argv = require('minimist')(process.argv.slice(2));

if (process.argv.length < 3)
{
	console.log('Usage:');
	console.log('webshortener [-h path] [--html path]',
				'[-c path] [--css path] [-j path] [--js path] path ...');
	process.exit(1);
}

var htmlFiles = [];
var jsFiles = [];
var cssFiles = [];


var parsePath = function(filePath, addHtml, addCss, addJs)
{
	var file = fs.realpathSync(filePath);
	if (!fs.existsSync(file))
		throw new Error('No such file: '+file);

	if (fs.statSync(filePath).isDirectory())
	{
		var files = fs.readdirSync(filePath);
		for (var i = 0; i < files.length; i++)
		{
			parsePath(path.join(filePath, files[i]), addHtml, addCss, addJs);
		}

		return;
	}

	switch (path.extname(file))
	{
		case '.html':
			if (addHtml) htmlFiles.push(file);
			break;

		case '.css':
			if (addCss) cssFiles.push(file);
			break;

		case '.js':
			if (addJs) jsFiles.push(file);
			break;
	}
};

var parseArray = function(arr, addHtml, addCss, addJs)
{
	if (arr == null) return;
	if (!util.isArray(arr))
	{
		parsePath(arr);
		return;
	}

	for (var i = 0; i < arr.length; i++)
	{
		parsePath(arr[i], addHtml, addCss, addJs);
	}
};

var printFinish = function(path)
{
	return function finished()
	{
		console.log('Finished parsing', path);
	};
};

parseArray(argv._, true, true, true);

parseArray(argv.html, true, false, false);
parseArray(argv.h   , true, false, false);

parseArray(argv.css, false, true, false);
parseArray(argv.c  , false, true, false);

parseArray(argv.js, false, true, false);
parseArray(argv.j , false, true, false);

var shrtnr = new Shortener();
for (var i = 0; i < htmlFiles.length; i++)
{
	var file = htmlFiles[i];

	fs.createReadStream(file).pipe(shrtnr.htmlShortener())
	.pipe(fs.createWriteStream(file+'.parsed'))
	.on('finish', printFinish(file));
}

for (i = 0; i < cssFiles.length; i++)
{
	var file = cssFiles[i];

	fs.createReadStream(file).pipe(shrtnr.cssShortener())
	.pipe(fs.createWriteStream(file+'.parsed'))
	.on('finish', printFinish(file));
}

for (i = 0; i < jsFiles.length; i++)
{
	var file = jsFiles[i];

	fs.createReadStream(file).pipe(shrtnr.jsShortener())
	.pipe(fs.createWriteStream(file+'.parsed'))
	.on('finish', printFinish(file));
}
